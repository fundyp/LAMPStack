<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
        crossorigin="anonymous">

    <!-- Custom styles for this template -->
    <link href="signin.css" rel="stylesheet">

    <title>Contact Manager</title>
</head>

<body class="text-center">

    <main class="form-signin">

        <!-- Contact Manager Form -->
        <form id="contactManagerForm">
            <!-- Welcome Greeting -->
            <h1 class="h3 mb-3 fw-normal" id="welcomeGreeting">Welcome!</h1>

            <!-- Search Contacts -->
            <div class="mb-3">
                <input type="text" class="form-control" id="searchInput" placeholder="Search Contacts"
                    oninput="searchContacts()">
            </div>

            <!-- Display User Contacts -->
            <ul id="userContacts" class="list-group">
                <!-- Contacts will be displayed here -->
            </ul>

            <!-- Add New Contact Section -->
            <h2 class="h5 mb-3 fw-normal">Add New Contact</h2>
            <div class="row g-2">
                <div class="col-md">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="firstName" placeholder="First Name" required>
                        <label for="firstName">First Name</label>
                    </div>
                </div>
                <div class="col-md">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="lastName" placeholder="Last Name" required>
                        <label for="lastName">Last Name</label>
                    </div>
                </div>
                <div class="col-md">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="phone" placeholder="Phone" required>
                        <label for="phone">Phone</label>
                    </div>
                </div>
                <div class="col-md">
                    <div class="form-floating">
                        <input type="email" class="form-control" id="email" placeholder="Email" required>
                        <label for="email">Email</label>
                    </div>
                </div>
                <div class="col-md-auto">
                    <button class="btn btn-lg btn-primary" type="button" onclick="addContact()">Add Contact</button>
                </div>
            </div>

            <!-- Logout Button -->
            <button class="btn btn-danger mt-3" type="button" onclick="logout()">Log Out</button>
        </form>
    </main>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

    <!-- Existing code for the switchForm function -->
    <script>
        // Add existing code for the switchForm function here

        // Function to load user contacts on page load
        window.onload = function () {
            loadUserContacts();
            displayWelcomeMessage();
        };

        let contacts = [];

        // // Function to load and display user contacts
        // function loadUserContacts() {
        //     const userId = getCookie('userID');
        //     return fetch(`http://138.197.77.6/LAMPAPI/SearchContacts.php`, {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json',
        //         },
        //         body: JSON.stringify({ search: '', userId }),
        //     })
        //         .then(response => {
        //             if (response.ok) {
        //                 return response.json();
        //             } else {
        //                 throw new Error('Error fetching user contacts');
        //             }
        //         })
        //         .then(data => {
        //             contacts = data; // Store contacts in the global variable
        //             displayUserContacts(contacts);
        //         })
        //         .catch(error => {
        //             console.error('Error fetching user contacts:', error.message);
        //         });
        // }

        // Function to load and display user contacts
function loadUserContacts() {
    const userId = getCookie('userID');
    return fetch(`http://nugget-nation.xyz/LAMPAPI/SearchContacts.php`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ search: '', userId }),
    })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Error fetching user contacts');
            }
        })
        .then(data => {
            contacts = data || []; // Ensure contacts is always an array
            displayUserContacts(contacts);
        })
        .catch(error => {
            console.error('Error fetching user contacts:', error.message);
        });
}

        function displayUserContacts(contacts) {
            const userContactsList = document.getElementById('userContacts');

            if (contacts.length > 0) {
                userContactsList.innerHTML = contacts.map(contact => (
                    `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h5>
                                <span id="editFirstName_${contact.ID}">${contact.FirstName}</span>
                                <span id="editLastName_${contact.ID}">${contact.LastName}</span>
                            </h5>
                            <p>Email: <span id="editEmail_${contact.ID}">${contact.Email}</span></p>
                            <p>Phone: <span id="editPhone_${contact.ID}">${contact.Phone}</span></p>
                        </div>
                        <button class="btn btn-danger" onclick="deleteContact('${contact.FirstName}', '${contact.LastName}')">Delete</button>
                        <button class="btn btn-primary" onclick="handleEditContact(${contact.ID})">Edit</button>
                        <button class="btn btn-success" onclick="doneEditingContact(${contact.ID})" style="display: none;">Done Editing</button>
                    </li>`
                )).join('');
            } else {
                userContactsList.innerHTML = '<li class="list-group-item">No contacts found.</li>';
            }
        }

        async function addContact() {
    const firstName = document.getElementById('firstName').value;
    const lastName = document.getElementById('lastName').value;
    const phone = document.getElementById('phone').value;
    const email = document.getElementById('email').value;
    const userId = getCookie('userID');

    const isDuplicate = isDuplicateContact(firstName, lastName, contacts);

    if (isDuplicate) {
        console.log('Duplicate contact. Not adding.');
        return;
    }

    const response = await fetch(`http://nugget-nation.xyz/LAMPAPI/AddContacts.php`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ firstName, lastName, phone, email, userId }),
    });

    const data = await response.json();

    if (response.ok) {
        console.log('Contact added successfully:', data);
        loadUserContacts();
    } else {
        console.error('Error adding contact:', data.error);
    }
}


// Function to check if a contact is a duplicate
function isDuplicateContact(firstName, lastName, existingContacts) {
    if (!Array.isArray(existingContacts)) {
        existingContacts = [];
    }

    return existingContacts.some(contact => {
        return (
            contact.FirstName.toLowerCase() === firstName.toLowerCase() &&
            contact.LastName.toLowerCase() === lastName.toLowerCase()
        );
    });
}


        function editContact(contact) {
            console.log('Editing contact:', contact);
            document.getElementById('updateFirstName').value = contact.FirstName;
            document.getElementById('updateLastName').value = contact.LastName;
            document.getElementById('updatePhone').value = contact.Phone;
            document.getElementById('updateEmail').value = contact.Email;
        }

        async function updateContact() {
            const updateFirstName = document.getElementById('updateFirstName').value;
            const updateLastName = document.getElementById('updateLastName').value;
            const updatePhone = document.getElementById('updatePhone').value;
            const updateEmail = document.getElementById('updateEmail').value;
            const userId = getCookie('userID');

            try {
                const response = await fetch('http://nugget-nation.xyz/LAMPAPI/UpdateContacts.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        firstName: updateFirstName,
                        lastName: updateLastName,
                        phone: updatePhone,
                        email: updateEmail,
                        userId: userId,
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Contact updated successfully:', data.result);
                    loadUserContacts();
                } else {
                    console.error('Error updating contact:', response.statusText);
                    const errorData = await response.text();
                    console.error('Error updating contact:', errorData);
                }
            } catch (error) {
                console.error('Error updating contact:', error.message);
            }
        }

        async function deleteContact(firstName, lastName) {
            const userId = getCookie('userID');

            if (!firstName || !lastName) {
                console.error("First Name and Last Name are required for deletion.");
                return;
            }

            try {
                const response = await fetch('http://nugget-nation.xyz/LAMPAPI/Delete.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ firstName, lastName, userId }),
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Contact deleted successfully:', data.result);
                    loadUserContacts();
                } else {
                    console.error('Error deleting contact:', response.statusText);
                    const errorData = await response.text();
                    console.error('Error deleting contact:', errorData);
                }
            } catch (error) {
                console.error('Error deleting contact:', error.message);
            }
        }

        function displayWelcomeMessage() {
            const userID = getCookie('userID');
            const welcomeGreeting = document.getElementById('welcomeGreeting');

            if (userID) {
                const firstName = getCookie('firstName');
                const lastName = getCookie('lastName');
                welcomeGreeting.textContent = `Welcome, ${firstName} ${lastName}!`;
            } else {
                console.error('User ID not found in cookies.');
            }
        }

        function logout() {
            document.cookie = 'userID=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = 'http://nugget-nation.xyz/signIn.html';
        }

        function getCookie(name) {
            const cookies = document.cookie.split(';');
            for (const cookie of cookies) {
                const [cookieName, cookieValue] = cookie.split('=');
                if (cookieName.trim() === name) {
                    return decodeURIComponent(cookieValue);
                }
            }
            return null;
        }

        async function handleEditContact(contactID) {
            const contactToEdit = await fetchContactByID(contactID);

            if (contactToEdit) {
                document.getElementById('updateFirstName').value = contactToEdit.FirstName;
                document.getElementById('updateLastName').value = contactToEdit.LastName;
                document.getElementById('updatePhone').value = contactToEdit.Phone;
                document.getElementById('updateEmail').value = contactToEdit.Email;

                const doneEditingBtn = document.getElementById('doneEditingBtn');
                doneEditingBtn.style.display = 'block';

                doneEditingBtn.onclick = function () {
                    doneEditingContact(contactID);
                };
            } else {
                console.error('Contact not found for editing:', contactID);
            }
        }

        async function fetchContactByID(contactID) {
            const userId = getCookie('userID');

            try {
                const response = await fetch('http://nugget-nation.xyz/LAMPAPI/SearchContacts.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ search: '', userId, contactID }),
                });

                if (response.ok) {
                    const data = await response.json();

                    if (data.length > 0) {
                        const contactToEdit = data[0];
                        console.log('Contact to edit:', contactToEdit);
                        return contactToEdit;
                    } else {
                        console.error('Contact not found for editing:', contactID);
                        return null;
                    }
                } else {
                    console.error('Error fetching contacts:', response.statusText);
                    const errorData = await response.text();
                    console.error('Error fetching contacts:', errorData);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching contacts:', error.message);
                return null;
            }
        }

        function doneEditingContact(contactID) {
    const updatedFirstName = document.getElementById(`editFirstName_${contactID}`).textContent;
    const updatedLastName = document.getElementById(`editLastName_${contactID}`).textContent;
    const updatedEmail = document.getElementById(`editEmail_${contactID}`).textContent;
    const updatedPhone = document.getElementById(`editPhone_${contactID}`).textContent;

    updateContact({
        ID: contactID,
        FirstName: updatedFirstName,
        LastName: updatedLastName,
        Email: updatedEmail,
        Phone: updatedPhone
    });

    const successBtn = document.querySelector(`#userContacts li button.btn-success`);
    if (successBtn) {
        successBtn.style.display = 'none';
    }
}

        async function searchContacts() {
            const searchInput = document.getElementById('searchInput').value;
            const userId = getCookie('userID');

            try {
                const response = await fetch('http://nugget-nation.xyz/LAMPAPI/SearchContacts.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ search: searchInput, userId }),
                });

                if (response.ok) {
                    const data = await response.json();
                    contacts = data;
                    displayUserContacts(contacts);
                } else {
                    console.error('Error searching contacts:', response.statusText);
                    const errorData = await response.text();
                    console.error('Error searching contacts:', errorData);
                }
            } catch (error) {
                console.error('Error searching contacts:', error.message);
            }
        }
    </script>
</body>

</html>
